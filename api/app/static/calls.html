<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìû Call History - Phone Proxy</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-primary: #0b141a;
            --bg-secondary: #111b21;
            --bg-tertiary: #1f2c33;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --accent-green: #00a884;
            --accent-blue: #53bdeb;
            --accent-orange: #ff7a00;
            --accent-red: #ea0038;
            --caller-bg: #1f2c33;
            --ai-bg: #005c4b;
            --border-color: #222d34;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            min-height: 100vh;
        }
        
        /* Navigation */
        .nav {
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            height: 44px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-links { display: flex; gap: 16px; align-items: center; }
        .nav a { text-decoration: none; color: var(--text-secondary); font-size: 13px; }
        .nav a:hover, .nav a.active { color: var(--text-primary); }
        .nav-title { font-weight: 600; font-size: 14px; }
        
        .container { max-width: 900px; margin: 0 auto; padding: 16px; }
        
        /* Stats bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        @media (max-width: 600px) {
            .stats-bar { grid-template-columns: repeat(2, 1fr); }
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .stat-value { font-size: 20px; font-weight: 600; color: var(--accent-blue); }
        .stat-label { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
        
        /* Call list */
        .call-list { display: flex; flex-direction: column; gap: 8px; }
        
        .call-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .call-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .call-header:hover { background: var(--bg-tertiary); }
        
        .call-caller { font-size: 14px; font-weight: 500; margin-bottom: 3px; }
        .call-meta {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .call-preview {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
            font-style: italic;
        }
        
        .expand-btn {
            background: none; border: none;
            color: var(--text-secondary);
            font-size: 14px; cursor: pointer;
            padding: 4px 8px;
            transition: transform 0.2s;
        }
        .expand-btn.expanded { transform: rotate(180deg); }
        
        /* Transcript */
        .call-transcript {
            display: none;
            padding: 0 12px 12px;
            border-top: 1px solid var(--border-color);
        }
        .call-transcript.expanded { display: block; }
        
        .transcript-turns {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 12px;
        }
        
        .turn { max-width: 80%; }
        .turn.caller { align-self: flex-start; }
        .turn.ai { align-self: flex-end; }
        
        .turn-bubble {
            padding: 6px 10px 4px;
            border-radius: 8px;
            min-width: 60px;
        }
        .turn.caller .turn-bubble {
            background: var(--caller-bg);
            border-top-left-radius: 0;
        }
        .turn.ai .turn-bubble {
            background: var(--ai-bg);
            border-top-right-radius: 0;
        }
        
        .turn-text { font-size: 13px; line-height: 1.35; }
        .turn-meta {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 2px;
            opacity: 0.8;
        }
        .turn-meta .latency { color: var(--accent-green); margin-left: 6px; }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-secondary);
        }
        .empty-state .icon { font-size: 40px; margin-bottom: 12px; opacity: 0.5; }
        .empty-state h3 { font-size: 16px; margin-bottom: 4px; color: var(--text-primary); }
        
        .loading {
            text-align: center;
            padding: 32px;
            color: var(--text-secondary);
            font-size: 13px;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-links">
            <span class="nav-title">üìû Phone Proxy</span>
            <a href="index.html">üî¥ Live</a>
            <a href="calls.html">üìã History</a>
            <a href="documents.html">üìÑ Docs</a>
            <a href="config.html">‚öôÔ∏è Config</a>
            <a href="analytics.html">üìä Analytics</a>
            <a href="system.html">üîß System</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="stats-bar" id="statsBar">
            <div class="stat-card">
                <div class="stat-value" id="totalCalls">-</div>
                <div class="stat-label">Total Calls</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="callsToday">-</div>
                <div class="stat-label">Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgDuration">-</div>
                <div class="stat-label">Avg Duration</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgLatency">-</div>
                <div class="stat-label">Avg Latency</div>
            </div>
        </div>
        
        <div class="call-list" id="callList">
            <div class="loading">Loading call history...</div>
        </div>
    </div>
    
    <script>
        async function loadStats() {
            try {
                const res = await fetch('/api/calls/stats');
                const stats = await res.json();
                document.getElementById('totalCalls').textContent = stats.total_calls || 0;
                document.getElementById('callsToday').textContent = stats.calls_today || 0;
                document.getElementById('avgDuration').textContent = formatDuration(stats.avg_duration_seconds);
                document.getElementById('avgLatency').textContent = stats.avg_latency_ms ? `${stats.avg_latency_ms}ms` : '-';
            } catch (e) {
                console.error('Failed to load stats:', e);
            }
        }
        
        async function loadCalls() {
            const list = document.getElementById('callList');
            
            try {
                const res = await fetch('/api/calls/history?limit=50');
                const data = await res.json();
                
                if (!data.calls || data.calls.length === 0) {
                    list.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üìû</div>
                            <h3>No calls yet</h3>
                            <p>Call history will appear here.</p>
                        </div>
                    `;
                    return;
                }
                
                list.innerHTML = data.calls.map(call => `
                    <div class="call-card" data-call-sid="${call.call_sid}">
                        <div class="call-header" onclick="toggleTranscript('${call.call_sid}')">
                            <div class="call-info">
                                <div class="call-caller">${formatCaller(call.caller)}</div>
                                <div class="call-meta">
                                    <span>üìÖ ${formatDate(call.started_at)}</span>
                                    <span>‚è±Ô∏è ${formatDuration(call.duration_seconds)}</span>
                                    <span>üí¨ ${call.turn_count || 0}</span>
                                    ${call.avg_latency_ms ? `<span>‚ö° ${call.avg_latency_ms}ms</span>` : ''}
                                </div>
                                ${call.preview ? `<div class="call-preview">"${escapeHtml(call.preview)}..."</div>` : ''}
                            </div>
                            <button class="expand-btn" id="btn-${call.call_sid}">‚ñº</button>
                        </div>
                        <div class="call-transcript" id="transcript-${call.call_sid}">
                            <div class="loading">Loading transcript...</div>
                        </div>
                    </div>
                `).join('');
                
            } catch (e) {
                console.error('Failed to load calls:', e);
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">‚ö†Ô∏è</div>
                        <h3>Error loading calls</h3>
                        <p>${e.message}</p>
                    </div>
                `;
            }
        }
        
        async function toggleTranscript(callSid) {
            const el = document.getElementById(`transcript-${callSid}`);
            const btn = document.getElementById(`btn-${callSid}`);
            const isExpanded = el.classList.contains('expanded');
            
            if (isExpanded) {
                el.classList.remove('expanded');
                btn.classList.remove('expanded');
            } else {
                el.classList.add('expanded');
                btn.classList.add('expanded');
                if (el.querySelector('.loading')) {
                    await loadTranscript(callSid);
                }
            }
        }
        
        async function loadTranscript(callSid) {
            const el = document.getElementById(`transcript-${callSid}`);
            
            try {
                const res = await fetch(`/api/calls/transcript/${callSid}`);
                const data = await res.json();
                
                if (!data.turns || data.turns.length === 0) {
                    el.innerHTML = '<p style="color:var(--text-secondary);padding:12px 0;font-size:12px;">No transcript available</p>';
                    return;
                }
                
                el.innerHTML = `
                    <div class="transcript-turns">
                        ${data.turns.map(turn => `
                            <div class="turn ${turn.speaker}">
                                <div class="turn-bubble">
                                    <div class="turn-text">${escapeHtml(turn.text)}</div>
                                    <div class="turn-meta">
                                        ${formatTime(turn.timestamp)}
                                        ${turn.latency_ms ? `<span class="latency">‚ö°${turn.latency_ms}ms</span>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (e) {
                el.innerHTML = `<p style="color:var(--accent-red);font-size:12px;">Error loading transcript</p>`;
            }
        }
        
        function formatCaller(phone) {
            if (!phone) return 'Unknown';
            return phone.replace(/^\+/, '').replace(/(\d{2})(\d{3})(\d{3})(\d+)/, '+$1 $2 $3 $4');
        }
        
        function formatDate(iso) {
            if (!iso) return '-';
            const d = new Date(iso);
            const now = new Date();
            const isToday = d.toDateString() === now.toDateString();
            if (isToday) {
                return `Today ${d.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}`;
            }
            return d.toLocaleDateString('en-GB', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'});
        }
        
        function formatTime(iso) {
            if (!iso) return '';
            return new Date(iso).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        }
        
        function formatDuration(secs) {
            if (!secs) return '-';
            const m = Math.floor(secs / 60);
            const s = Math.round(secs % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        loadStats();
        loadCalls();
    </script>
</body>
</html>