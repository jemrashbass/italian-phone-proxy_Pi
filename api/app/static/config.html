<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Italian Phone Proxy</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5; 
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { margin-bottom: 20px; color: #333; }
        
        .nav {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .nav a {
            margin-right: 20px;
            text-decoration: none;
            color: #007AFF;
        }
        .nav a:hover { text-decoration: underline; }
        
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: white;
            padding: 4px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .tab:hover { background: #f0f0f0; }
        .tab.active {
            background: #007AFF;
            color: white;
        }
        
        .panel {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .panel.active { display: block; }
        .panel h2 {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #555;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007AFF;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group small {
            display: block;
            margin-top: 4px;
            color: #999;
            font-size: 0.8em;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .btn-primary { background: #007AFF; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        
        .save-bar {
            position: sticky;
            bottom: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        
        .accounts-list {
            display: grid;
            gap: 16px;
        }
        .account-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
        }
        .account-card h4 {
            font-size: 1em;
            margin-bottom: 12px;
            color: #333;
            display: flex;
            justify-content: space-between;
        }
        .account-card .detail {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.9em;
        }
        .account-card .detail .label { color: #666; }
        .account-card .detail .value { font-family: monospace; }
        
        .json-view {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8em;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="/dashboard/">üè† Dashboard</a>
        <a href="/documents.html">üìÑ Documents</a>
        <a href="/config.html">‚öôÔ∏è Config</a>
        <a href="/calls.html">üìû Call History</a>
    </nav>
    
    <h1>‚öôÔ∏è Knowledge Base Configuration</h1>
    
    <div id="alertContainer"></div>
    
    <div class="tabs">
        <button class="tab active" onclick="showTab('identity')">Identity</button>
        <button class="tab" onclick="showTab('location')">Location</button>
        <button class="tab" onclick="showTab('accounts')">Accounts</button>
        <button class="tab" onclick="showTab('preferences')">Preferences</button>
        <button class="tab" onclick="showTab('raw')">Raw JSON</button>
    </div>
    
    <div id="identity" class="panel active">
        <h2>ü™™ Identity</h2>
        <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="identity.name" placeholder="As it appears on utility bills">
        </div>
        <div class="form-group">
            <label>Codice Fiscale</label>
            <input type="text" id="identity.codice_fiscale" placeholder="16-character code" maxlength="16" style="text-transform: uppercase;">
            <small>Italian tax ID - used for identity verification</small>
        </div>
        <div class="form-group">
            <label>Opening Phrase</label>
            <textarea id="identity.opening_phrase" placeholder="What the AI says at the start of calls"></textarea>
            <small>Explain you're English and your Italian isn't perfect</small>
        </div>
    </div>
    
    <div id="location" class="panel">
        <h2>üìç Location</h2>
        <div class="form-row">
            <div class="form-group">
                <label>Via/Street</label>
                <input type="text" id="location.address.via" placeholder="Via Roma">
            </div>
            <div class="form-group">
                <label>Number</label>
                <input type="text" id="location.address.numero" placeholder="42">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>CAP (Postcode)</label>
                <input type="text" id="location.address.cap" placeholder="00100" maxlength="5">
            </div>
            <div class="form-group">
                <label>Comune (City)</label>
                <input type="text" id="location.address.comune" placeholder="Roma">
            </div>
            <div class="form-group">
                <label>Provincia</label>
                <input type="text" id="location.address.provincia" placeholder="RM" maxlength="2" style="text-transform: uppercase;">
            </div>
        </div>
        
        <h3 style="margin: 24px 0 16px;">Directions for Delivery Drivers</h3>
        <div class="form-group">
            <label>From Main Road</label>
            <textarea id="location.directions.from_main_road" placeholder="Coming from the main road, turn left at the pharmacy..."></textarea>
        </div>
        <div class="form-group">
            <label>House Description</label>
            <input type="text" id="location.directions.house_description" placeholder="Yellow house with green shutters and a red gate">
        </div>
        <div class="form-group">
            <label>Gate Code (if applicable)</label>
            <input type="text" id="location.gate_code" placeholder="1234#">
        </div>
        <div class="form-group">
            <label>Google Maps URL</label>
            <input type="url" id="location.google_maps_url" placeholder="https://maps.google.com/...">
        </div>
    </div>
    
    <div id="accounts" class="panel">
        <h2>üíº Utility Accounts</h2>
        <p style="color: #666; margin-bottom: 20px;">
            Accounts are populated automatically when you approve document extractions.
            <a href="/documents.html">Upload documents ‚Üí</a>
        </p>
        <div id="accountsList" class="accounts-list">
            <div class="empty-state">Loading accounts...</div>
        </div>
    </div>
    
    <div id="preferences" class="panel">
        <h2>üéØ Preferences</h2>
        <div class="form-group">
            <label>Preferred Appointment Time</label>
            <input type="text" id="preferences.preferred_time" placeholder="la mattina / il pomeriggio">
        </div>
        <div class="form-group">
            <label>Available Days (comma-separated)</label>
            <input type="text" id="preferences.available_days_text" placeholder="luned√¨, marted√¨, mercoled√¨">
        </div>
        
        <h3 style="margin: 24px 0 16px;">House Details</h3>
        <div class="form-row">
            <div class="form-group">
                <label>Neighbour Name</label>
                <input type="text" id="house.neighbour_name" placeholder="Signora Rossi">
            </div>
            <div class="form-group">
                <label>Neighbour Relation</label>
                <input type="text" id="house.neighbour_relation" placeholder="la vicina di casa">
            </div>
        </div>
        <div class="form-group">
            <label>Safe Place for Deliveries</label>
            <input type="text" id="house.safe_place" placeholder="behind the gate / with the neighbour">
        </div>
    </div>
    
    <div id="raw" class="panel">
        <h2>üìã Raw Knowledge JSON</h2>
        <p style="color: #666; margin-bottom: 16px;">
            View the complete knowledge base that powers the phone agent.
        </p>
        <div id="rawJson" class="json-view">Loading...</div>
        <div style="margin-top: 16px;">
            <button class="btn btn-secondary" onclick="copyJson()">üìã Copy JSON</button>
            <button class="btn btn-secondary" onclick="loadKnowledge()">üîÑ Reload</button>
        </div>
    </div>
    
    <div class="save-bar">
        <span id="saveStatus">No unsaved changes</span>
        <button class="btn btn-primary" onclick="saveChanges()">üíæ Save Changes</button>
    </div>
    
    <script>
        let knowledge = {};
        let hasChanges = false;
        
        function showTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update panels
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }
        
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }
        
        async function loadKnowledge() {
            try {
                knowledge = await fetch('/api/config/knowledge').then(r => r.json());
                populateForm();
                renderAccounts();
                document.getElementById('rawJson').textContent = JSON.stringify(knowledge, null, 2);
            } catch (e) {
                showAlert('Failed to load knowledge: ' + e.message, 'error');
            }
        }
        
        function populateForm() {
            // Identity
            setValue('identity.name', knowledge.identity?.name);
            setValue('identity.codice_fiscale', knowledge.identity?.codice_fiscale);
            setValue('identity.opening_phrase', knowledge.identity?.opening_phrase);
            
            // Location
            setValue('location.address.via', knowledge.location?.address?.via);
            setValue('location.address.numero', knowledge.location?.address?.numero);
            setValue('location.address.cap', knowledge.location?.address?.cap);
            setValue('location.address.comune', knowledge.location?.address?.comune);
            setValue('location.address.provincia', knowledge.location?.address?.provincia);
            setValue('location.directions.from_main_road', knowledge.location?.directions?.from_main_road);
            setValue('location.directions.house_description', knowledge.location?.directions?.house_description);
            setValue('location.gate_code', knowledge.location?.gate_code);
            setValue('location.google_maps_url', knowledge.location?.google_maps_url);
            
            // Preferences
            setValue('preferences.preferred_time', knowledge.preferences?.preferred_time);
            const days = knowledge.preferences?.available_days || [];
            setValue('preferences.available_days_text', days.join(', '));
            setValue('house.neighbour_name', knowledge.house?.neighbour_name);
            setValue('house.neighbour_relation', knowledge.house?.neighbour_relation);
            setValue('house.safe_place', knowledge.house?.safe_place);
            
            // Add change listeners
            document.querySelectorAll('input, textarea').forEach(el => {
                el.addEventListener('input', markChanged);
            });
        }
        
        function setValue(id, value) {
            const el = document.getElementById(id);
            if (el) el.value = value || '';
        }
        
        function getValue(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }
        
        function markChanged() {
            hasChanges = true;
            document.getElementById('saveStatus').textContent = '‚óè Unsaved changes';
            document.getElementById('saveStatus').style.color = '#dc3545';
        }
        
        function renderAccounts() {
            const container = document.getElementById('accountsList');
            const accounts = knowledge.accounts || {};
            
            if (Object.keys(accounts).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        No accounts configured yet.<br>
                        <a href="/documents.html">Upload a utility bill</a> to extract account information.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = Object.entries(accounts).map(([key, acc]) => {
                const history = acc.history || [];
                const historyRows = history.map(h => `
                    <tr>
                        <td>${h.document_date || '-'}</td>
                        <td>${h.period_start || ''} - ${h.period_end || ''}</td>
                        <td style="text-align: right;">${h.amount ? '‚Ç¨' + h.amount.toFixed(2) : '-'}</td>
                        <td style="text-align: right;">${h.reading || '-'}</td>
                    </tr>
                `).join('');
                
                return `
                <div class="account-card">
                    <h4>
                        ${acc.provider || key}
                        <span style="font-weight: normal; color: #999; font-size: 0.85em;">${acc.type || ''}</span>
                    </h4>
                    ${acc.identifiers?.codice_cliente ? `
                        <div class="detail">
                            <span class="label">Codice Cliente</span>
                            <span class="value">${acc.identifiers.codice_cliente}</span>
                        </div>
                    ` : ''}
                    ${acc.identifiers?.pod ? `
                        <div class="detail">
                            <span class="label">POD</span>
                            <span class="value">${acc.identifiers.pod}</span>
                        </div>
                    ` : ''}
                    ${acc.identifiers?.pdr ? `
                        <div class="detail">
                            <span class="label">PDR</span>
                            <span class="value">${acc.identifiers.pdr}</span>
                        </div>
                    ` : ''}
                    ${acc.contact?.phone ? `
                        <div class="detail">
                            <span class="label">Servizio Clienti</span>
                            <span class="value">${acc.contact.phone}</span>
                        </div>
                    ` : ''}
                    ${acc.current_bill?.amount ? `
                        <div class="detail" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                            <span class="label">Latest Bill</span>
                            <span class="value" style="font-weight: 600;">‚Ç¨${acc.current_bill.amount}</span>
                        </div>
                    ` : ''}
                    
                    ${history.length > 0 ? `
                        <details style="margin-top: 12px;">
                            <summary style="cursor: pointer; color: #007AFF; font-size: 0.9em;">
                                üìä Billing History (${history.length} records)
                            </summary>
                            <div style="margin-top: 10px; overflow-x: auto;">
                                <table style="width: 100%; font-size: 0.85em; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8f9fa; text-align: left;">
                                            <th style="padding: 6px;">Date</th>
                                            <th style="padding: 6px;">Period</th>
                                            <th style="padding: 6px; text-align: right;">Amount</th>
                                            <th style="padding: 6px; text-align: right;">Reading</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${historyRows}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    ` : ''}
                    
                    <div class="detail" style="margin-top: 8px; font-size: 0.8em; color: #999;">
                        <span>Last updated: ${acc.updated ? new Date(acc.updated).toLocaleDateString() : 'Unknown'}</span>
                    </div>
                </div>
            `}).join('');
        }
        
        async function saveChanges() {
            const updates = [
                { path: 'identity.name', value: getValue('identity.name') },
                { path: 'identity.codice_fiscale', value: getValue('identity.codice_fiscale').toUpperCase() },
                { path: 'identity.opening_phrase', value: getValue('identity.opening_phrase') },
                { path: 'location.address.via', value: getValue('location.address.via') },
                { path: 'location.address.numero', value: getValue('location.address.numero') },
                { path: 'location.address.cap', value: getValue('location.address.cap') },
                { path: 'location.address.comune', value: getValue('location.address.comune') },
                { path: 'location.address.provincia', value: getValue('location.address.provincia').toUpperCase() },
                { path: 'location.directions.from_main_road', value: getValue('location.directions.from_main_road') },
                { path: 'location.directions.house_description', value: getValue('location.directions.house_description') },
                { path: 'location.gate_code', value: getValue('location.gate_code') },
                { path: 'location.google_maps_url', value: getValue('location.google_maps_url') },
                { path: 'preferences.preferred_time', value: getValue('preferences.preferred_time') },
                { path: 'preferences.available_days', value: getValue('preferences.available_days_text').split(',').map(s => s.trim()).filter(Boolean) },
                { path: 'house.neighbour_name', value: getValue('house.neighbour_name') },
                { path: 'house.neighbour_relation', value: getValue('house.neighbour_relation') },
                { path: 'house.safe_place', value: getValue('house.safe_place') },
            ];
            
            try {
                for (const update of updates) {
                    await fetch('/api/config/knowledge', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(update)
                    });
                }
                
                hasChanges = false;
                document.getElementById('saveStatus').textContent = '‚úì Saved';
                document.getElementById('saveStatus').style.color = '#28a745';
                showAlert('Configuration saved successfully!');
                
                // Reload to get updated data
                await loadKnowledge();
                
            } catch (e) {
                showAlert('Failed to save: ' + e.message, 'error');
            }
        }
        
        function copyJson() {
            const json = document.getElementById('rawJson').textContent;
            navigator.clipboard.writeText(json);
            showAlert('JSON copied to clipboard');
        }
        
        // Initial load
        loadKnowledge();
    </script>
</body>
</html>
