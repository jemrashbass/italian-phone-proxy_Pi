<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è Config - Phone Proxy</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-primary: #0b141a;
            --bg-secondary: #111b21;
            --bg-tertiary: #1f2c33;
            --bg-input: #2a3942;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --accent-green: #00a884;
            --accent-blue: #53bdeb;
            --accent-orange: #ff7a00;
            --accent-red: #ea0038;
            --border-color: #222d34;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
            min-height: 100vh;
        }
        
        /* Navigation */
        .nav {
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            height: 44px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .nav-links { display: flex; gap: 16px; align-items: center; }
        .nav a { text-decoration: none; color: var(--text-secondary); font-size: 13px; }
        .nav a:hover, .nav a.active { color: var(--text-primary); }
        .nav-title { font-weight: 600; font-size: 14px; }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 16px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            background: var(--bg-secondary);
            padding: 4px;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 8px 14px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }
        .tab:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .tab.active { background: var(--accent-green); color: white; }
        
        .panel {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            display: none;
        }
        .panel.active { display: block; }
        .panel h2 {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        .panel h3 {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin: 20px 0 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-group {
            margin-bottom: 14px;
        }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-secondary);
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: border-color 0.2s;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent-green);
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group small {
            display: block;
            margin-top: 4px;
            color: var(--text-secondary);
            font-size: 11px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--accent-green); color: white; }
        .btn-primary:hover { background: #00916e; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--bg-input); }
        
        /* Save bar */
        .save-bar {
            position: sticky;
            bottom: 16px;
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            border: 1px solid var(--border-color);
        }
        .save-bar span { font-size: 12px; color: var(--text-secondary); }
        
        /* Accounts */
        .accounts-list { display: grid; gap: 12px; }
        .account-card {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            background: var(--bg-tertiary);
        }
        .account-card h4 {
            font-size: 13px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .account-card h4 span {
            font-weight: normal;
            color: var(--text-secondary);
            font-size: 11px;
        }
        .account-card .detail {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }
        .account-card .detail .label { color: var(--text-secondary); }
        .account-card .detail .value { font-family: monospace; font-size: 11px; }
        
        .account-card details {
            margin-top: 10px;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
        }
        .account-card summary {
            cursor: pointer;
            color: var(--accent-blue);
            font-size: 11px;
        }
        .account-card table {
            width: 100%;
            font-size: 11px;
            border-collapse: collapse;
            margin-top: 8px;
        }
        .account-card th {
            text-align: left;
            padding: 4px 6px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-weight: 500;
        }
        .account-card td {
            padding: 4px 6px;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* JSON view */
        .json-view {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            color: var(--text-primary);
        }
        
        /* Alert */
        .alert {
            padding: 10px 14px;
            border-radius: 6px;
            margin-bottom: 12px;
            font-size: 12px;
        }
        .alert-success { background: rgba(0, 168, 132, 0.2); color: var(--accent-green); }
        .alert-error { background: rgba(234, 0, 56, 0.2); color: var(--accent-red); }
        
        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--text-secondary);
            font-size: 12px;
        }
        .empty-state a { color: var(--accent-blue); }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-links">
            <span class="nav-title">üìû Phone Proxy</span>
            <a href="index.html">üî¥ Live</a>
            <a href="calls.html">üìã History</a>
            <a href="documents.html">üìÑ Docs</a>
            <a href="config.html">‚öôÔ∏è Config</a>
            <a href="analytics.html">üìä Analytics</a>
        </div>
    </nav>
    
    <div class="container">
        <div id="alertContainer"></div>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('identity')">Identity</button>
            <button class="tab" onclick="showTab('location')">Location</button>
            <button class="tab" onclick="showTab('accounts')">Accounts</button>
            <button class="tab" onclick="showTab('preferences')">Preferences</button>
            <button class="tab" onclick="showTab('raw')">Raw JSON</button>
        </div>
        
        <div id="identity" class="panel active">
            <h2>ü™™ Identity</h2>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="identity.name" placeholder="As it appears on utility bills">
            </div>
            <div class="form-group">
                <label>Codice Fiscale</label>
                <input type="text" id="identity.codice_fiscale" placeholder="16-character code" maxlength="16" style="text-transform: uppercase;">
                <small>Italian tax ID - used for identity verification</small>
            </div>
            <div class="form-group">
                <label>Opening Phrase</label>
                <textarea id="identity.opening_phrase" placeholder="What the AI says at the start of calls"></textarea>
                <small>Explain you're English and your Italian isn't perfect</small>
            </div>
        </div>
        
        <div id="location" class="panel">
            <h2>üìç Location</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>Via/Street</label>
                    <input type="text" id="location.address.via" placeholder="Via Roma">
                </div>
                <div class="form-group">
                    <label>Number</label>
                    <input type="text" id="location.address.numero" placeholder="42">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>CAP</label>
                    <input type="text" id="location.address.cap" placeholder="00100" maxlength="5">
                </div>
                <div class="form-group">
                    <label>Comune</label>
                    <input type="text" id="location.address.comune" placeholder="Roma">
                </div>
                <div class="form-group">
                    <label>Provincia</label>
                    <input type="text" id="location.address.provincia" placeholder="RM" maxlength="2" style="text-transform: uppercase;">
                </div>
            </div>
            
            <h3>Directions for Delivery Drivers</h3>
            <div class="form-group">
                <label>From Main Road</label>
                <textarea id="location.directions.from_main_road" placeholder="Coming from the main road, turn left at..."></textarea>
            </div>
            <div class="form-group">
                <label>House Description</label>
                <input type="text" id="location.directions.house_description" placeholder="Yellow house with green shutters">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Gate Code</label>
                    <input type="text" id="location.gate_code" placeholder="1234#">
                </div>
                <div class="form-group">
                    <label>Google Maps URL</label>
                    <input type="url" id="location.google_maps_url" placeholder="https://maps.google.com/...">
                </div>
            </div>
        </div>
        
        <div id="accounts" class="panel">
            <h2>üíº Utility Accounts</h2>
            <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 12px;">
                Accounts are populated automatically from document extractions.
                <a href="documents.html" style="color: var(--accent-blue);">Upload documents ‚Üí</a>
            </p>
            <div id="accountsList" class="accounts-list">
                <div class="empty-state">Loading...</div>
            </div>
        </div>
        
        <div id="preferences" class="panel">
            <h2>üéØ Preferences</h2>
            <div class="form-group">
                <label>Preferred Appointment Time</label>
                <input type="text" id="preferences.preferred_time" placeholder="la mattina / il pomeriggio">
            </div>
            <div class="form-group">
                <label>Available Days (comma-separated)</label>
                <input type="text" id="preferences.available_days_text" placeholder="luned√¨, marted√¨, mercoled√¨">
            </div>
            
            <h3>House Details</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Neighbour Name</label>
                    <input type="text" id="house.neighbour_name" placeholder="Signora Rossi">
                </div>
                <div class="form-group">
                    <label>Neighbour Relation</label>
                    <input type="text" id="house.neighbour_relation" placeholder="la vicina di casa">
                </div>
            </div>
            <div class="form-group">
                <label>Safe Place for Deliveries</label>
                <input type="text" id="house.safe_place" placeholder="behind the gate / with the neighbour">
            </div>
        </div>
        
        <div id="raw" class="panel">
            <h2>üìã Raw Knowledge JSON</h2>
            <p style="color: var(--text-secondary); margin-bottom: 12px; font-size: 12px;">
                Complete knowledge base that powers the phone agent.
            </p>
            <div id="rawJson" class="json-view">Loading...</div>
            <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button class="btn btn-secondary" onclick="copyJson()">üìã Copy</button>
                <button class="btn btn-secondary" onclick="loadKnowledge()">üîÑ Reload</button>
            </div>
        </div>
        
        <div class="save-bar">
            <span id="saveStatus">No unsaved changes</span>
            <button class="btn btn-primary" onclick="saveChanges()">üíæ Save Changes</button>
        </div>
    </div>
    
    <script>
        let knowledge = {};
        let hasChanges = false;
        
        function showTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }
        
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 4000);
        }
        
        async function loadKnowledge() {
            try {
                knowledge = await fetch('/api/config/knowledge').then(r => r.json());
                populateForm();
                renderAccounts();
                document.getElementById('rawJson').textContent = JSON.stringify(knowledge, null, 2);
            } catch (e) {
                showAlert('Failed to load: ' + e.message, 'error');
            }
        }
        
        function populateForm() {
            setValue('identity.name', knowledge.identity?.name);
            setValue('identity.codice_fiscale', knowledge.identity?.codice_fiscale);
            setValue('identity.opening_phrase', knowledge.identity?.opening_phrase);
            setValue('location.address.via', knowledge.location?.address?.via);
            setValue('location.address.numero', knowledge.location?.address?.numero);
            setValue('location.address.cap', knowledge.location?.address?.cap);
            setValue('location.address.comune', knowledge.location?.address?.comune);
            setValue('location.address.provincia', knowledge.location?.address?.provincia);
            setValue('location.directions.from_main_road', knowledge.location?.directions?.from_main_road);
            setValue('location.directions.house_description', knowledge.location?.directions?.house_description);
            setValue('location.gate_code', knowledge.location?.gate_code);
            setValue('location.google_maps_url', knowledge.location?.google_maps_url);
            setValue('preferences.preferred_time', knowledge.preferences?.preferred_time);
            setValue('preferences.available_days_text', (knowledge.preferences?.available_days || []).join(', '));
            setValue('house.neighbour_name', knowledge.house?.neighbour_name);
            setValue('house.neighbour_relation', knowledge.house?.neighbour_relation);
            setValue('house.safe_place', knowledge.house?.safe_place);
            
            document.querySelectorAll('input, textarea').forEach(el => el.addEventListener('input', markChanged));
        }
        
        function setValue(id, value) {
            const el = document.getElementById(id);
            if (el) el.value = value || '';
        }
        
        function getValue(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }
        
        function markChanged() {
            hasChanges = true;
            document.getElementById('saveStatus').textContent = '‚óè Unsaved changes';
            document.getElementById('saveStatus').style.color = 'var(--accent-orange)';
        }
        
        function renderAccounts() {
            const container = document.getElementById('accountsList');
            const accounts = knowledge.accounts || {};
            
            if (Object.keys(accounts).length === 0) {
                container.innerHTML = '<div class="empty-state">No accounts yet.<br><a href="documents.html">Upload a utility bill</a></div>';
                return;
            }
            
            container.innerHTML = Object.entries(accounts).map(([key, acc]) => {
                const history = acc.history || [];
                const historyRows = history.map(h => `
                    <tr>
                        <td>${h.document_date || '-'}</td>
                        <td>${h.period_start || ''} - ${h.period_end || ''}</td>
                        <td style="text-align:right">${h.amount ? '‚Ç¨' + h.amount.toFixed(2) : '-'}</td>
                        <td style="text-align:right">${h.reading || '-'}</td>
                    </tr>
                `).join('');
                
                return `
                <div class="account-card">
                    <h4>${acc.provider || key} <span>${acc.type || ''}</span></h4>
                    ${acc.identifiers?.codice_cliente ? `<div class="detail"><span class="label">Codice Cliente</span><span class="value">${acc.identifiers.codice_cliente}</span></div>` : ''}
                    ${acc.identifiers?.pod ? `<div class="detail"><span class="label">POD</span><span class="value">${acc.identifiers.pod}</span></div>` : ''}
                    ${acc.identifiers?.pdr ? `<div class="detail"><span class="label">PDR</span><span class="value">${acc.identifiers.pdr}</span></div>` : ''}
                    ${acc.contact?.phone ? `<div class="detail"><span class="label">Servizio Clienti</span><span class="value">${acc.contact.phone}</span></div>` : ''}
                    ${acc.current_bill?.amount ? `<div class="detail" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border-color)"><span class="label">Latest Bill</span><span class="value" style="font-weight:600">‚Ç¨${acc.current_bill.amount}</span></div>` : ''}
                    ${history.length > 0 ? `
                        <details>
                            <summary>üìä History (${history.length})</summary>
                            <table>
                                <thead><tr><th>Date</th><th>Period</th><th style="text-align:right">Amount</th><th style="text-align:right">Reading</th></tr></thead>
                                <tbody>${historyRows}</tbody>
                            </table>
                        </details>
                    ` : ''}
                    <div class="detail" style="margin-top:8px;font-size:10px;color:var(--text-secondary)">
                        Updated: ${acc.updated ? new Date(acc.updated).toLocaleDateString() : 'Unknown'}
                    </div>
                </div>
            `}).join('');
        }
        
        async function saveChanges() {
            const updates = [
                { path: 'identity.name', value: getValue('identity.name') },
                { path: 'identity.codice_fiscale', value: getValue('identity.codice_fiscale').toUpperCase() },
                { path: 'identity.opening_phrase', value: getValue('identity.opening_phrase') },
                { path: 'location.address.via', value: getValue('location.address.via') },
                { path: 'location.address.numero', value: getValue('location.address.numero') },
                { path: 'location.address.cap', value: getValue('location.address.cap') },
                { path: 'location.address.comune', value: getValue('location.address.comune') },
                { path: 'location.address.provincia', value: getValue('location.address.provincia').toUpperCase() },
                { path: 'location.directions.from_main_road', value: getValue('location.directions.from_main_road') },
                { path: 'location.directions.house_description', value: getValue('location.directions.house_description') },
                { path: 'location.gate_code', value: getValue('location.gate_code') },
                { path: 'location.google_maps_url', value: getValue('location.google_maps_url') },
                { path: 'preferences.preferred_time', value: getValue('preferences.preferred_time') },
                { path: 'preferences.available_days', value: getValue('preferences.available_days_text').split(',').map(s => s.trim()).filter(Boolean) },
                { path: 'house.neighbour_name', value: getValue('house.neighbour_name') },
                { path: 'house.neighbour_relation', value: getValue('house.neighbour_relation') },
                { path: 'house.safe_place', value: getValue('house.safe_place') },
            ];
            
            try {
                for (const update of updates) {
                    await fetch('/api/config/knowledge', {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(update)
                    });
                }
                hasChanges = false;
                document.getElementById('saveStatus').textContent = '‚úì Saved';
                document.getElementById('saveStatus').style.color = 'var(--accent-green)';
                showAlert('Configuration saved!');
                await loadKnowledge();
            } catch (e) {
                showAlert('Failed to save: ' + e.message, 'error');
            }
        }
        
        function copyJson() {
            navigator.clipboard.writeText(document.getElementById('rawJson').textContent);
            showAlert('JSON copied to clipboard');
        }
        
        loadKnowledge();
    </script>
</body>
</html>