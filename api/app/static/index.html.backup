<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Italian Phone Proxy - Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5; 
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 { margin-bottom: 20px; color: #333; }
        
        .nav {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .nav a {
            margin-right: 20px;
            text-decoration: none;
            color: #007AFF;
        }
        .nav a:hover {
            text-decoration: underline;
        }
        
        .status-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .status-banner h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }
        .status-banner .status {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 0.9em;
        }
        .status-banner .status.active {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        .card h3 {
            font-size: 1.1em;
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card p {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 16px;
        }
        .card a {
            display: inline-block;
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            transition: background 0.2s;
        }
        .card a:hover {
            background: #0056b3;
        }
        
        .quick-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .stat {
            text-align: center;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.8em;
            opacity: 0.9;
        }
        
        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .recent-activity h3 {
            margin-bottom: 16px;
            color: #333;
        }
        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.2em;
        }
        .activity-icon.call { background: #e3f2fd; }
        .activity-icon.doc { background: #f3e5f5; }
        .activity-details {
            flex: 1;
        }
        .activity-title {
            font-weight: 500;
            color: #333;
        }
        .activity-time {
            font-size: 0.8em;
            color: #999;
        }
        
        .empty-activity {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <a href="/dashboard/">üè† Dashboard</a>
        <a href="/documents.html">üìÑ Documents</a>
        <a href="/config.html">‚öôÔ∏è Config</a>
        <a href="/calls.html">üìû Call History</a>
    </nav>
    
    <div class="status-banner">
        <h2>üáÆüáπ Italian Phone Proxy</h2>
        <span class="status" id="systemStatus">System Loading...</span>
        <div class="quick-stats">
            <div class="stat">
                <div class="stat-value" id="callCount">-</div>
                <div class="stat-label">Calls Today</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="docCount">-</div>
                <div class="stat-label">Pending Docs</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="accountCount">-</div>
                <div class="stat-label">Accounts</div>
            </div>
        </div>
    </div>
    
    <div class="grid">
        <div class="card">
            <h3>üìÑ Document Extraction</h3>
            <p>Upload Italian utility bills and documents. AI extracts account numbers, addresses, and other key information for the phone agent.</p>
            <a href="/documents.html">Upload Documents ‚Üí</a>
        </div>
        
        <div class="card">
            <h3>‚öôÔ∏è Knowledge Base</h3>
            <p>View and edit the knowledge that powers the AI phone agent. Address, account details, preferences, and more.</p>
            <a href="/config.html">Edit Knowledge ‚Üí</a>
        </div>
        
        <div class="card">
            <h3>üìû Call History</h3>
            <p>Review past calls with full transcripts. See how the AI handled different situations and learn from real conversations.</p>
            <a href="/calls.html">View Calls ‚Üí</a>
        </div>
        
        <div class="card">
            <h3>üîß System Status</h3>
            <p>Check API connections, telephony status, and system health. Ensure everything is ready for incoming calls.</p>
            <a href="/health" target="_blank">Health Check ‚Üí</a>
        </div>
    </div>
    
    <div class="recent-activity">
        <h3>Recent Activity</h3>
        <div id="activityList">
            <div class="empty-activity">
                Loading activity...
            </div>
        </div>
    </div>
    
    <script>
        async function loadDashboard() {
            // Check system health
            try {
                const health = await fetch('/health').then(r => r.json());
                document.getElementById('systemStatus').textContent = 
                    health.status === 'healthy' ? '‚úì System Ready' : '‚ö† System Issue';
                document.getElementById('systemStatus').classList.toggle('active', health.status === 'healthy');
            } catch (e) {
                document.getElementById('systemStatus').textContent = '‚úó System Offline';
            }
            
            // Load pending documents count
            try {
                const docs = await fetch('/api/documents/pending').then(r => r.json());
                document.getElementById('docCount').textContent = docs.pending.length;
            } catch (e) {
                document.getElementById('docCount').textContent = '?';
            }
            
            // Load knowledge stats
            try {
                const knowledge = await fetch('/api/config/knowledge').then(r => r.json());
                const accountCount = Object.keys(knowledge.accounts || {}).length;
                document.getElementById('accountCount').textContent = accountCount;
            } catch (e) {
                document.getElementById('accountCount').textContent = '?';
            }
            
            // Load call count (mock for now)
            document.getElementById('callCount').textContent = '0';
            
            // Load recent activity
            await loadRecentActivity();
        }
        
        async function loadRecentActivity() {
            const activityList = document.getElementById('activityList');
            const activities = [];
            
            try {
                // Get recent calls
                const calls = await fetch('/api/calls/history?limit=3').then(r => r.json());
                for (const call of calls.calls || []) {
                    activities.push({
                        type: 'call',
                        title: `Call from ${call.caller}`,
                        time: call.timestamp,
                        icon: 'üìû'
                    });
                }
            } catch (e) {}
            
            try {
                // Get pending docs
                const docs = await fetch('/api/documents/pending').then(r => r.json());
                for (const doc of (docs.pending || []).slice(0, 3)) {
                    activities.push({
                        type: 'doc',
                        title: `Document: ${doc.document_id}`,
                        time: doc.uploaded_at,
                        icon: 'üìÑ'
                    });
                }
            } catch (e) {}
            
            // Sort by time
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            if (activities.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-activity">
                        No recent activity.<br>
                        <a href="/documents.html">Upload a document</a> to get started.
                    </div>
                `;
                return;
            }
            
            activityList.innerHTML = activities.slice(0, 5).map(a => `
                <div class="activity-item">
                    <div class="activity-icon ${a.type}">${a.icon}</div>
                    <div class="activity-details">
                        <div class="activity-title">${a.title}</div>
                        <div class="activity-time">${formatTime(a.time)}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function formatTime(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return `${Math.floor(diff/60000)} min ago`;
            if (diff < 86400000) return `${Math.floor(diff/3600000)} hours ago`;
            return date.toLocaleDateString();
        }
        
        // Load on page ready
        loadDashboard();
        
        // Refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
